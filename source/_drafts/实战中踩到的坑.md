---
title: 实战中踩到的坑
urlname: pits-stepped-on-in-actual-combat
id: 876
categories:
    - 总结
tags:
    - 前端
    - 技巧
    - 笔记
date: 2017-06-16 20:21:11
---

## Safari 中的 cookie 问题

Safari 默认是不允许第三方网站跨域带 cookie 的，所以只能像客户端那样，通过 Header 来传递用户认证的 token 了。

## border-image 和 boder-radius 不兼容问题

我们在给 border 做渐变效果时会使用 border-image 这个属性，但是 border-image 和 border-radius 不能同时使用，为什么呢？

1. border-radius 是一个边框的样式，当没有边框的时候会作用到背景上。
2. border-image（[MDN](https://developer.mozilla.org/zh-CN/docs/Web/CSS/border-image)） 也是边框的一个属性，但是只有这个属性无法显示时才会显示 border 的默认样式，即：

```css
border:15px solid #F33;
```

所以一旦有了 border-image，浏览器应用了之后，border-radius 的属性会被覆盖即失效。如果想要在实现渐变效果的同时有圆角应该怎么做呢？有两种解决方案（[demo预览]()）：

### 方案一：伪元素

主要思路是将本来想作用在border上的渐变效果通过伪元素的背景色实现，然后因为 background-image 和 border-radius 不冲突，这样就间接的实现了想要的效果：

```css
.container{
    position: relative;
    border-radius: 20px;
    background: #fff;
}
.container:after{
    content: "";
	display: block;
	position: absolute;
	top: -5px;
	right: -5px;
	bottom: -5px;
	left: -5px;
	border-radius: 20px;
	background: linear-gradient(to top, red, orange, yellow);
	z-index: -1;
}
```

### 方案二：外层添加父元素

和方案一的实现思路类似，都是利用 background-image 间接实现 border 渐变效果，主要区别是通过在外层添加 padding 的方式来间接实现 border 效果：

```css
.container {
    background-image: linear-gradient(to top, red, orange, yellow);
    /* 相当于有个5px的 border */
    padding: 5px;
    border-radius: 20px;
}

.container-child{
    background: #fff;
    border-radius: 20px;
    height: 100%;
}
```

具体的demo可以[点击这里](//merrier.wang/code-demo/border-image/index.html)查看

## iPhone上的点击事件

有这样一段代码：
```javascript
<div class="name">点我</div>
$(document).on("click", ".name", function() {
    alert("name");
});
```
以上代码在电脑浏览器和安卓上都能触发 alert 事件，但是在 iOS 上却完全没有反应，是因为：**iPhone手机上的 div 元素没有 click 事件，只有 touch 事件**，就是说如果这个是 button 这种可 click 的元素，click 事件是可以触发的，但是 div 这种本身默认不可点击的元素就不能触发了，有以下两种解决方案：

### 给这个元素添加样式

```css
.name{
    cursor:pointer;
}
```

### 将 click 改为 touchstart

可以让 click 和 touchstart 共存：
```javascript
$(document).on("click touchstart", ".name", function() {
    alert("name");
});
```

本人推荐第一种解决方案，方便简单

## 结合 React Hooks 添加 Scroll 事件

如果单纯添加滚动事件，很简单：

```javascript
useEffect(() => {
    const onScroll = e => {
        const top = e.target.documentElement.scrollTop;
        // ...
    };
    window.addEventListener("scroll", onScroll);

    return () => window.removeEventListener("scroll", onScroll);
}, []);
```

但是如果你需要根据当前的 `scrollTop` 值判断是否在滚动的话，需要将 `scrollTop` 添加进依赖项，比如：

```javascript
useEffect(() => {
    const onScroll = e => {
        setScrollTop(e.target.documentElement.scrollTop);
        setScrolling(e.target.documentElement.scrollTop > scrollTop);
    };
    window.addEventListener("scroll", onScroll);

    return () => window.removeEventListener("scroll", onScroll);
}, [scrollTop]);
```

## antd 中 table rowKey 不一致导致 bug

antd 中的 rowKey 要求比较严格的一个属性，如果 rowKey 的值有重合会直接报 warning：

<div align='center'><img src='/images/hexo_post_352.png' alt=''/></div>

而 rowKey 不一致还会导致各种莫名其妙的 bug，如表格错位等

# 变量与选择器

需求是这样的，类似于标签页，当我点击某个 tab 时需要显示对应的 content，同时将其他 content 隐藏，所以一般都会这样写：

```javascript
var ip = \$(this).parents(".tab").attr("data-ip");

\$(".content").find(".content-item\[data-ip=" + ip + "\]").show().siblings().hide();
```

理论上这样写是没有问题的，但是如果你的 ip 从后台传过来的时候是以数字的形式传过来的话，在页面中展示是没有问题的，但是获取之后再用上面这种方法就会找不到该元素，原因就是如果没有变量的话，选择器是这样的$(".content-item\[data-ip='1000'\]"),也就是说data-ip一定要是个字符串，所以在用上面那种形式定位的时候，JS会先判断你的ip变量是否是字符串类型，如果不是就直接报错；所以正确的写法是强行加一对单引号' '在ip变量周围：$(".content-item\[data-ip='" + ip + "' \]")（注意单引号的位置）

# video 无法播放

video 作为 h5 新增的标签，自然问题不少，但是在开发的过程中遇到了之前从来没有遇到过的问题（之前也用的比较少），就是 video 无法播放的问题，经过排查，src 的路径是正确的，其他参数该有的都有，但是仍然无法播放，经过向前辈们请教，才发现新大陆：

## 1.video 和 audio 都有跨域问题

可以看一下[MDN 的这篇文章](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video)，重点看一下 crossorigin 属性

## 2.video 中的 src 地址有猫腻

解决完跨域问题之后，发现仍然无法播放，所以就咨询了一下前辈，前辈看了一下我的 video 标签的 src 属性就发现了问题所在，因为有些网站为了自己的资源不被“非法人员”引用，同时也是为了节省自己网站流量，就会在自己视频的链接地址中加一些安全内容，比如 signature、cookie 相关代码，或者时间戳等常见保护措施，从而导致其他不在他“白名单”中的网站是没办法将他网站的视频加入到自己网站上的，所以就会出现无法正常播放的问题，解决方案很简单：联系视频来源网站或者换一家网站的视频

# django 模板中的数组索引

django 作为一个比较简单的前端 web 框架，其本身的 template 提供了很多功能，如变量、标签、过滤等，但是我在前端模板中想要通过索引获取数组中某一项时却遇到了麻烦，比如后来 render 的时候传给前端一个数组 array，我想取得 array 的第一项，大部分语言可以通过 array\[0\]获取到，然而在 django 中却报错：template syntex error；后来查阅了一些资料之后才知道，django 模板中的数组索引需要用小数点.来进行查找（array.0），援引[Django 模板系统](http://blog.csdn.net/zhangxinrun/article/details/8095118)中的解释，当模板系统遇到变量名里有小数点时会按以下顺序查找：

1.  **字典**查找，如**foo\["bar"\]**
2.  **属性**查找，如**foo.bar**
3.  **方法**调用，如**foo.bar()**
4.  列表的**索引**查找，如**foo\[bar\]**

小数点可以**多级纵深查询**，例如{ { person.name.upper }}表示字典查询 person\['name'\]然后调用 upper()方法；也就是说，**在 django 模板中是不存在"\[\]"的，小数点.可以达到各种你想要的结果！**

# jsonp 不是万能的

比如我现在页面的 url 是https://toutiao.com/...，然后我需要向www.toutiao.com请求数据，理论上这应该属于跨域，所以就需要设置ajax的dataType为jsonp类型，然后请求并没有发送成功，这是为什么呢？因为虽然当前页面的域名是toutiao.com，但是其实服务器已经做了重定向（301到了www.toutiao.com），所以如果向www.toutiao.com请求数据是不会跨域的，dataType改为json就可以了；但是有时候即便没有跨域，dataType设置为jsonp也是可以的，这又是为什么呢？因为看后台配不配合了，因为jsonp是需要前端和后端约定好jsonp的callback的，所以稳妥起见：**如果没有跨域，就不要用jsonp了！**

# 移动端慎用 tap

做过移动端的前端同学可能会知道，zepto 对于移动端封装了一个独特的事件叫做 tap，其行为特点和平常我们经常用到的 click 差不多，只不过 tap 更强调是“手指按一下屏幕而不是划过”，而 click 在移动端也会有延迟的问题，但是我在项目中遇到一个很坑的问题是：给一个元素绑定了 tap 事件，但是我按一下就会触发两次事件。后来把 tap 换成 click（移动端也可以用 click）之后就没有再出现这个问题了，所以如果你今后在开发移动端项目的时候碰到了 tap 事件，一定要谨慎啊！（后来查资料得知，有一个叫做[fastclick](https://github.com/ftlabs/fastclick)的插件可以解决 click 在移动端上的延迟问题，如果你对用户体验要求苛刻同时又想避免 tap 的“点透”问题，可以尝试一下这个插件） 推荐文章：[移动端 web，tap 与 click 事件](http://www.jianshu.com/p/19eebc1921b6)

# ant design select 问题

https://github.com/ant-design/ant-design/issues/4832

# Object 属性遍历问题

http://jartto.wang/2016/10/25/does-js-guarantee-object-property-order/

# IOS Javascript Date 的坑

http://www.iamaddy.net/2015/02/ios-javascript-date/

# 优化移动端 window.onscroll 的执行频率方案

https://zhuanlan.zhihu.com/p/32061260

# 移动端输入框填坑系列

http://www.alloyteam.com/2017/03/moves-the-input-box-fill-series-a/

# nodeJS 踩坑-记本地地址 127.0.0.1 与 0.0.0.0 的区别

https://www.imooc.com/article/7581

# H5 与 APP 混合开发遇到的问题总结

https://juejin.im/post/5aa8b00c51882555627cfa0e

# decodeURIComponent 报错的坑

https://cnodejs.org/topic/4fd6b7ba839e1e581407aac8 https://stackoverflow.com/questions/28063750/decodeuricomponent-throwing-an-error-uri-malformed

# -webkit-box-orient 不见了， webkit 和 autoprefixer 的坑

https://blog.csdn.net/sinat_24070543/article/details/79755285

# 移动端弹框后禁止背景屏幕滑动的解决方案

https://dancon.gitbooks.io/git-books/content/js/essay/dialog\_forbid\_back_scroll.html

## 无法生成 package-lock.json 文件

习惯用 cnpm 进行依赖的安装，但是有一次通过 cnpm install 时没有办法生成 / 更新 package-lock.json 文件，后来试了一下 npm install 就可以了。。所以如果你需要手动生成 package-lock.json 文件又不想用 npm install 命令时，可以尝试手动设置 registry：

```bash
npm --registry https://registry.npm.taobao.org install
```

如果安装不成功，尝试将 node_modules 文件夹删掉后再试试- -，npm 就是如此神奇。如果想更方便的切换源，可以安装 nrm：

```bash
npm i nrm -g
```

## || 和 &&

&& 和 || 是有优先级之分的（&& 的优先级为 6，|| 的优先级为 5），所以可以理解成 && 的结合优先级高于 ||，用人脑模拟一下就是加上小括号：

```javascript
console.log(true || (false && false)); // true
```

上面这道题可以理解为 `true || (false && false)`，所以结果为 true

### Markdown 编辑表格时如何输入竖线

https://blog.csdn.net/u013553529/article/details/51024733

## react 怎么实现点击空白关闭？

https://zhuanlan.zhihu.com/p/27721969

## -webkit-box-orient: vertical; 不生效

试试下面这段 CSS 代码：

```css
/* autoprefixer: off */
-webkit-box-orient: vertical;
/* autoprefixer: on */
```

## React 中插入 HTML 代码

```
dangerouslySetInnerHTML={{ __html: data }}
```

## prop-types 中的布尔类型

prop-types 中的布尔类型是 `bool`，而不是 `boolean`

## IOS Javascript Date 的坑

http://www.iamaddy.net/2015/02/ios-javascript-date/

## html2canvas font-size 解析错误

在 issue 中找到了答案：https://github.com/niklasvh/html2canvas/issues/1661#issuecomment-424327354，需要将 `font-variant` 属性设置为 normal

## moment() 对象问题

moment 是一个很知名的 JS 日期处理类库，但是在使用的时候遇到了一个坑，不过不是 moment 的问题，是 JS 本身语言特性导致。具体如下：首先，`moment()` 的返回值是一个 moment 对象，所以当我们对如下数组进行遍历时，最终得到的值会不符合预期：

```javascript
const momentNow = moment("2019-03-01", "YYYY-MM-DD");
const test = [momentNow.startOf("month"), momentNow.subtract(1, "weeks"), momentNow.subtract(30, "days")];

test.map(d => {
    console.log(d.unix()); // 1548172800 1548172800 1548172800
});
```

我们声明的 `momentNow` 是一个对象，所以当我们遍历时，其实是对这个对象进行了连续操作，像上面我们打印出来了三次相同的值，都是等于 `moment('2019-03-01', 'YYYY-MM-DD').startOf('month').subtract(1, 'weeks').subtract(30, 'days').unix()`，所以当我们想对一个 `moment` 对象进行遍历时，最好是 `分开声明`，不要缓存变量：

```javascript
const test = [
    moment("2019-03-01", "YYYY-MM-DD").startOf("month"),
    moment("2019-03-01", "YYYY-MM-DD").subtract(1, "weeks"),
    moment("2019-03-01", "YYYY-MM-DD").subtract(30, "days")
];

test.map(d => {
    console.log(d.unix()); // 1551369600 1550764800 1548777600
});
```

## focus() 不生效的问题

有时候会遇到 focus() 不生效的问题，尤其是这个 focus 事件在某元素的 click 事件中时，此时可以考虑将 click 事件换成 movedown 事件，然后 focus 放到 setTimeout 中，这样就可以解决不生效的问题。

## Git 默认不区分文件大小写

这是个很难察觉的问题，因为 git 默认对于文件名的大小写是不敏感的，所以如果你只是修改了文件名的大小写，git 是察觉不到的，会提示代码没有任何改动。。不过也可以通过配置让 git 识别文件名大小写变化：

### 第一种，更改 git 配置

```bash
git config core.ignorecase false
```

### 第二种，先删除再提交

```bash
# 删除
git rm readme.md
# 重新添加
git add Readme.md
# 提交
git commit -m 'Readme.md'
```

推荐第一种方法，第二种只能临时解决；关于为什么 git 会如此设计，可以参考知乎——[为什么 git 默认不区分文件夹大小写？](https://www.zhihu.com/question/57779034)

### 扩展阅读

-   [浅谈 blur 与 click 冲突的问题](https://blog.csdn.net/zhouziyu2011/article/details/53942285)
-   [关于 focus()不生效的问题](https://blog.csdn.net/jingjingshizhu/article/details/79802326)

## typescript 中 使用 react-router-dom 问题

在项目迁移 typescript 过程中，遇到了一个 react-router-dom 问题，下面的代码会报错：

```tsx
import * as React from "react";
import { withRouter } from "react-router-dom";

interface IProps {
    title: string;
}

class MyComp extends React.Component<IProps> {
    public render() {
        return <h1>{this.props.title}</h1>;
    }
}

export default withRouter(MyComp);
```

在 [stackoverflow](https://stackoverflow.com/questions/48219432/react-router-typescript-errors-on-withrouter-after-updating-version) 上面找到了解决方案：

```tsx
import * as React from "react";
import { RouteComponentProps, withRouter } from "react-router-dom";

interface IProps extends RouteComponentProps<any> {
    title: string;
}

class MyComp extends React.Component<IProps> {
    public render() {
        return <h1>{this.props.title}</h1>;
    }
}

export default withRouter<IProps>(MyComp);
```

## @types/XXX 文件安装之后仍不生效

在使用库 dom-to-image 时，需要手动安装类型定义文件：

```bash
npm install @types/dom-to-image -D
```

然而安装之后编辑器（VSCode）还是报错，然后重启编辑器之后就不报错了。。

## Antd Form 组件在 typescript 中的使用问题

在 TypeScript 中使用 Form.create() 可能会抛出类似下面的错误：

```bash
error TS2339: Property 'loading' does not exist on type 'IntrinsicAttributes & IntrinsicClassAttributes<Compone
nt<{}, ComponentState>> & Readonly<{ childr...'.
```

这是因为 props 的类型没有通过检查，以下是正确的方式（来自 [Antd 官方文档](<https://pro.ant.design/docs/uset-typescript-cn#Form.create()>)）：

```ts
import { FormComponentProps } from "antd/lib/form/Form";

interface IFormComponentProps extends FormComponentProps {
  test: string;
}

class FormComponent extends React.Component<IFormComponentProps> {
  constructor(props: IFormComponentProps) {
    super(props);
    ....
  }
  render() {
    const { getFieldDecorator } = this.props.form;
    return ....;
  }
}
```

## 其他人遇到的问题和解决方案

- [关于 input 的一些问题解决方法分享](https://juejin.im/post/5af68903f265da0b84557fab)
- [移动端常见 bug 汇总 001](https://juejin.im/post/5af918636fb9a07ac5603ecb)
- [JavaScript 复制内容到剪贴板](https://github.com/axuebin/articles/issues/26)
- [移动 Web 开发问题和优化小结](https://juejin.im/post/59c4c9d85188254f58412d17)
- [移动端输入框填坑系列（一）](http://www.alloyteam.com/2017/03/moves-the-input-box-fill-series-a/)
- [移动端H5页面开发坑点指南](https://juejin.im/post/5dafc3df5188257a63539c64)
- [https://juejin.im/post/5d6e1899e51d453b1e478b29](https://juejin.im/post/5d6e1899e51d453b1e478b29)