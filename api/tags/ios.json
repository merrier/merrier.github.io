{"name":"ios","postlist":[{"title":"iOS中采用AMP规范时的scroll和position:fixed带来的bug","slug":"iOS中采用AMP规范时的scroll和position:fixed带来的bug","date":"2017-08-26T12:23:20.000Z","updated":"2019-02-04T06:11:30.226Z","comments":true,"path":"api/articles/iOS中采用AMP规范时的scroll和position:fixed带来的bug.json","excerpt":null,"keywords":"merrier 博客 前端 北邮人","cover":null,"content":"<p>本文翻译自一位前辈的两篇文章，原文链接：</p>\n<ul>\n<li><a href=\"https://medium.com/@dvoytenko/amp-ios-scrolling-and-position-fixed-b854a5a0d451\" target=\"_blank\" rel=\"noopener\">AMP, iOS, Scrolling and Position Fixed</a></li>\n<li><a href=\"https://hackernoon.com/amp-ios-scrolling-and-position-fixed-redo-the-wrapper-approach-8874f0ee7876\" target=\"_blank\" rel=\"noopener\">AMP, iOS, Scrolling and Position Fixed Redo — the wrapper approach</a></li>\n</ul>\n<p>首先，你需要先了解一下 AMP，<a href=\"https://imququ.com/post/amp-project.html\" target=\"_blank\" rel=\"noopener\">点击这里</a></p>\n<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>我们对于 AMP 的目标是确保 document 文档在不同环境中都是可嵌入的，无论是单独查看还是在 webview 中或者在 iframe 中——总体而言，它在不同环境中的功能和行为表现都应该尽可能相同。我们将从一个简单的栗子开始，在这个栗子中，一个 AMP 文档通过 iframe 被嵌入了一个 web app。这听起来很正常，但是很实在的说，iframes 在最近已经很少有人用了。闲话少说，html 结构是这样的：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>I’m a Web App and I show AMP documents<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">    iframe &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      position: absolute;</span></span><br><span class=\"line\"><span class=\"undefined\">      top: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">      left: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">      right: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">      bottom: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">iframe</span> … <span class=\"attr\">width</span>=<span class=\"string\">\"100%\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"100%\"</span></span></span><br><span class=\"line\"><span class=\"tag\">   <span class=\"attr\">scrolling</span>=<span class=\"string\">\"yes\"</span></span></span><br><span class=\"line\"><span class=\"tag\">   <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.ampproject.org/c/pub1.com/doc1\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">iframe</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>上面这段代码通常来说在移动设备上表现良好。然后我们有了一个新的想法，我们尝试将 iframe 调整到整个 document 的高度，同时使用 static 定位，从而将滚动委托给上一层的 window。然而，出于一些原因，我们放弃了这种方法：</p>\n<ul>\n<li>当视口高度等于文档高度时，在嵌入的AMP文档中设置<code>“position: fixed”</code>是不会起作用的</li>\n<li>计算文档高度容易出错，而且有延迟</li>\n</ul>\n<p>当然，我们最终没有很好的解决方案。主要是，设置了<code>“scrolling=yes”</code>的 iframe 会丢失一些移动设备的特性，比如滚动时隐藏地址栏。然而，我们仍然觉得这已经是一个很好的折衷方案了。除此之外，一些浏览器已经开始尝试将这些特性扩展到非 body 滚动的情况中。我们就这样美滋滋，直到我们遇到了 iOS。。</p>\n<h3 id=\"问题1：iOS-不支持-iframe-的-“scrollable-yes”\"><a href=\"#问题1：iOS-不支持-iframe-的-“scrollable-yes”\" class=\"headerlink\" title=\"问题1：iOS 不支持 iframe 的 “scrollable=yes”\"></a>问题1：iOS 不支持 iframe 的 <code>“scrollable=yes”</code></h3><p>Bug：<a href=\"https://bugs.webkit.org/show_bug.cgi?id=149264\" target=\"_blank\" rel=\"noopener\">https://bugs.webkit.org/show_bug.cgi?id=149264</a> 简单的说：<strong>ios中不能有可以滚动的iframe</strong>。然而，我们找到了解决这个 bug 的方法。参考这里<a href=\"https://github.com/ampproject/amphtml/blob/de7a14d/src/service/viewport-impl.js#L754\" target=\"_blank\" rel=\"noopener\">ViewportBindingNaturalIosEmbed_</a>。简短而言，我们让 document 中真正的<code>&lt;body&gt;</code>元素滚动。这样的话，即使 iframe 自身不滚动，它里面的内容也会滚动。 我们按照上面方案修改后的 AMP 文档如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">  <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">    \"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们以为自己很牛逼，然而。。</p>\n<h3 id=\"问题2：现在-scrollTop，scrollLeft，scrollHeight，scrollWidth-不管用了\"><a href=\"#问题2：现在-scrollTop，scrollLeft，scrollHeight，scrollWidth-不管用了\" class=\"headerlink\" title=\"问题2：现在 scrollTop，scrollLeft，scrollHeight，scrollWidth 不管用了\"></a>问题2：现在 scrollTop，scrollLeft，scrollHeight，scrollWidth 不管用了</h3><p>Bug：<a href=\"https://bugs.webkit.org/show_bug.cgi?id=106133\" target=\"_blank\" rel=\"noopener\">https://bugs.webkit.org/show_bug.cgi?id=106133</a> 这是 webkit 中长期存在的一个 bug。scrollTop 和其他类似属性被分配给了 <code>“document.body”</code>，但是却委托给了<code>“document.documentElement”</code>。最终，当 “scrollingElement” 是文档里的大部分元素的时候，这个问题会被解决。同时，令人惊喜的是，这个 bug 不会对我们在问题1中提出的解决方案造成冲突。然而，<code>“scrollTop”</code> 将会一直是 0，从而导致其他连带属性也会受到影响，比如 <code>“window.pageYOffset”</code> 解决方案是添加一个滚动的元素到文档顶部。它的 <code>“getBoundingClientRect().top”</code> 就可以用来重新计算文档的滚动位置。 具体如下所示：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">    \"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"scroll-pos\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        width: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        height: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        visibility: hidden;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们的 JS 代码：</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getScrollTop</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">  <span class=\"comment\">// 要对scrollPos.top取负值的原因是滚动位置在计算时，</span></span><br><span class=\"line\">  <span class=\"comment\">// 我们的scrollPos元素会向上滚动，在视口范围外,</span></span><br><span class=\"line\">  <span class=\"comment\">// 此时它的top值是负的</span></span><br><span class=\"line\">  <span class=\"keyword\">return</span> -scrollPos.getBoundingClientRect().top;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>从上面的代码可以看出，这个解决方案显得很蠢，但是它确实奏效了。类似的方法可用于“scrollLeft”，“scrollHeight” 以及剩余属性。 然而，我们又有了新的发现。。</p>\n<h3 id=\"问题3：“postion-fixed”-的元素在-“overflow-auto”-容器中会有很多-bug\"><a href=\"#问题3：“postion-fixed”-的元素在-“overflow-auto”-容器中会有很多-bug\" class=\"headerlink\" title=\"问题3：“postion: fixed” 的元素在 “overflow: auto” 容器中会有很多 bug\"></a>问题3：“postion: fixed” 的元素在 “overflow: auto” 容器中会有很多 bug</h3><p>Bug：<a href=\"https://bugs.webkit.org/show_bug.cgi?id=154399\" target=\"_blank\" rel=\"noopener\">https://bugs.webkit.org/show_bug.cgi?id=154399</a> 如果一个 “position: fixed” 元素在一个 “overflow: auto” 的容器中，它的表现会让你很失望：滚动的时候，“position: fixed” 元素会跳远和闪现。它看起来像是稍微滚动一点然而又跳回到正确的位置。这个效果很差，可以通过这个<a href=\"https://drive.google.com/file/d/0B_v8thsbiGyDMXZMZkRFZGFRbjA/view?usp=sharing\" target=\"_blank\" rel=\"noopener\">视频演示</a>看到这个 bug。 要哭了。我们通过各种 hack 解决了各种 bug，最后还是有一个 bug，我们如何解决这个？这里有一个很疯狂的 idea 貌似好使。我们可以添加一个虚拟元素到 “document.documentElement”（不是 “body”，所以它其实是 “body” 的兄弟元素）。我们把它叫做“<strong>固定层</strong>”。他将占据整个视口。我们将使用CSS来找到所有的可能是 “fixed” 的元素（希望不会有太多。。），如果在某些时候它们是确定 “fixed” 的，我们就通过正确的 “z-index” 属性将它们移动到“固定层” 你可能看晕了，直接上代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"css\">    <span class=\"selector-id\">#fixed-element</span> &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">      position: fixed;</span></span><br><span class=\"line\"><span class=\"undefined\">      right: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">      top: 20px;</span></span><br><span class=\"line\"><span class=\"undefined\">    &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">  </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">    \"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"fixed-element\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"fixed-layer\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      width: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      height: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      pointer-events: none;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">    \"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当我们找到一个确实 “fixed” 的元素的时候，我们将它移动到“固定层”，像这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"fixed-layer\"</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      pointer-events: none;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">    \"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"fixed-element\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"pointer-events: initial; z-index: 11;\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>因此，我们可以根据某元素是否 “fixed” 来将它在 “\bbody” 中的原始位置和“固定层”之间移动。 这个方法就无懈可击了吗？很明显没有：</p>\n<ul>\n<li>\b这代码看都看不懂！</li>\n<li>计算 “z-index” 会相当痛苦</li>\n<li>我们将失去一些 CSS 祖先选择器</li>\n</ul>\n<p>但是它确实是有效的，可以看一下<a href=\"http://github.com/ampproject/amphtml/pull/2128\" target=\"_blank\" rel=\"noopener\">这条PR</a>。还有别的 idea 吗？ 准确来说是有的，下面是作者第二篇文章的译文：</p>\n<h2 id=\"回顾一下\"><a href=\"#回顾一下\" class=\"headerlink\" title=\"回顾一下\"></a>回顾一下</h2><p>简单回顾一下，AMP 文档经常在一个滚动的 iframe 中进行展示。它的 html 结构看起来像这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>I'm a Web App and I show AMP documents<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"undefined\">      iframe &#123;</span></span><br><span class=\"line\"><span class=\"undefined\">        position: absolute;</span></span><br><span class=\"line\"><span class=\"undefined\">        top: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">        left: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">        right: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">        bottom: 0;</span></span><br><span class=\"line\"><span class=\"undefined\">      &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">    </span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">iframe</span> … <span class=\"attr\">width</span>=<span class=\"string\">\"100%\"</span> <span class=\"attr\">height</span>=<span class=\"string\">\"100%\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">scrolling</span>=<span class=\"string\">\"yes\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">src</span>=<span class=\"string\">\"https://cdn.ampproject.org/c/pub1.com/doc1\"</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">iframe</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>在大部分浏览器中，上面这段代码表现很正常。但是在 ios 中会有很多异常表现，我们尝试了很多方法，包括通过内容调整 iframe 大小和滚动主文档。但是他们都有一些性能问题，具体可以参见上面的问题描述。 根本而言，ios 的 safari 浏览器不支持滚动的 iframe。换句话说，<code>“scrolling=yes”</code> 这个属性被直接忽略了。<a href=\"http://jsbin.com/gugika/edit?html,css,output\" target=\"_blank\" rel=\"noopener\">看这个例子</a>。这个 bug 由来已久，可以<a href=\"https://bugs.webkit.org/show_bug.cgi?id=149264\" target=\"_blank\" rel=\"noopener\">在这里</a>发现。 我们在<a href=\"https://github.com/ampproject/amphtml/blob/de7a14d/src/service/viewport-impl.js#L754\" target=\"_blank\" rel=\"noopener\">之前提到的一篇文章</a>中发现了一个很原始的方案。简而言之，我们让真正的 “body” 元素滚动。于是，即使 iframe 它自身不滚动，iframe 中的内容也会滚动，AMP 文档如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">!\\-\\-</span> <span class=\"attr\">document</span> <span class=\"attr\">content</span> <span class=\"attr\">--</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>现在我们 iframe 可以滚动了！这个 AMP 中的解决方案我们用了一年。然而，随着时间的流逝，我们发现了一系列的问题，这些问题在上一篇文章中已经详细介绍过了，这里再简单罗列一下： 给“ body” 添加 “position: absolute” 属性是作者不想看到的，会影响原始布局。另外一个副作用是我们不没办法在 “body” 元素上设置 margin body 的 scrollTop，scrollLeft，scrollHeight 和 scrollWidth 将不起作用。这个 bug 通过上面介绍的注入虚拟 dom 元素可以解决。 “position: fixed” 在 “-webkit-overflow-scrolling: touch” 容器中会有各种 bug 抵消 header 和 footer 需要给 body 设置边框，这个代价很昂贵，因为它缩小了滚动区域，同时可能会打破现有布局。而隐藏头部又会造成 UI 视觉的隔断和滚动的间断 那我们如何解决这个问题呢，我们的主角就要登场了。。</p>\n<h3 id=\"新的解决方案——wrapper-元素\"><a href=\"#新的解决方案——wrapper-元素\" class=\"headerlink\" title=\"新的解决方案——wrapper 元素\"></a>新的解决方案——wrapper 元素</h3><p>这个方案已开源，可以<a href=\"https://github.com/ampproject/amphtml/blob/2d73ac0d9c451dee4c89ac1fa73329b69edca5a4/src/service/viewport-impl.js#L1404\" target=\"_blank\" rel=\"noopener\">点击这里</a>查看源代码</p>\n<h3 id=\"DOM-结构\"><a href=\"#DOM-结构\" class=\"headerlink\" title=\"DOM 结构\"></a>DOM 结构</h3><p>通俗来讲，wrapper 元素和滚动的 “body” 元素是类似的。iframe 在 ios 的 safari 浏览器中依然无法滚动，所以我们需要让 iframe 中的内容滚动。因为让<code>&lt;body&gt;</code>滚动会有一系列问题，所以我们可以创建一个滚动的 wrapper，然后将它放在<code>&lt;html&gt;</code>和<code>&lt;body&gt;</code>中间。换句话说，我们将<code>&lt;body&gt;</code>元素包装在一个可滚动的容器中。 现在的 dom 结构类似这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">i-amp-html-wrapper</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        display: block;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">\"position: relative;\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">!\\-\\-</span> <span class=\"attr\">document</span> <span class=\"attr\">content</span> <span class=\"attr\">--</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">i-amp-html-wrapper</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>毫无疑问，这看起来很怪，但是它确实解决了原来的问题——它让 iframe 在 ios 的 safari 浏览器中可以滚动。此外，它也解决了上面描述的许多问题：</p>\n<ul>\n<li>对于<code>&lt;body&gt;</code>元素没有任何强制要求：它仍然拥有原来的“position”属性，同时也可以拥有默认的“overflow: visible”属性。AMP 允许 dom 中的大多数 css 样式，这样可以减少对代码原作者样式的干扰</li>\n<li>可滚动的 wrapper 元素可以用来获取 scrollTop，scrollLeft，scrollHeight 和 scrollWidth 属性，于是之前介绍过的虚拟元素将不再需要</li>\n<li>不再需要给<code>&lt;body&gt;</code>设置边界来抵消 header 和 footer 了——只需要给 wrapper 元素添加 padding 就足够了</li>\n</ul>\n<p>然而，“position: fixed” 的问题仍然存在，我们稍后再谈。</p>\n<h3 id=\"两个-lt-html-gt-元素\"><a href=\"#两个-lt-html-gt-元素\" class=\"headerlink\" title=\"两个&lt;html&gt;元素\"></a>两个<code>&lt;html&gt;</code>元素</h3><p>我们采用了 wrapper 方案，然后很快就碰到了一个小问题。很多人喜欢 html&gt;body 选择器，而我们在 <code>&lt;html&gt;</code> 和 <code>&lt;body&gt;</code> 中间插入了 i-amp-html-wrapper 元素。为了解决这个问题，我们将 i-amp-html-wrapper 作为另外一个 <code>&lt;html&gt;</code> 元素，最终的 dom 结构长这样：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">id</span>=<span class=\"string\">\"i-amp-html-wrapper\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        display: block;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">\"position: relative;\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">!\\-\\-</span> <span class=\"attr\">document</span> <span class=\"attr\">content</span> <span class=\"attr\">--</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>加倍奇怪，加倍好玩。总而言之现在 html&gt;body 选择器将正常起作用</p>\n<h3 id=\"实践\"><a href=\"#实践\" class=\"headerlink\" title=\"实践\"></a>实践</h3><p>AMP runtime 会在启动时尽可能早的创建 wrapper 元素。而现有的 <code>&lt;body&gt;</code> 元素会作为子元素放到新建 wrapper 里面</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Create wrapper.</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> wrapper = <span class=\"built_in\">document</span>.createElement(<span class=\"string\">'html'</span>);</span><br><span class=\"line\">wrapper.id = <span class=\"string\">'i-amp-html-wrapper'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Setup classes and styles.</span></span><br><span class=\"line\">wrapper.className = <span class=\"built_in\">document</span>.documentElement.className;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.documentElement.className = <span class=\"string\">''</span>;</span><br><span class=\"line\"><span class=\"built_in\">document</span>.documentElement.style = <span class=\"string\">'...'</span>;</span><br><span class=\"line\">wrapper.style = <span class=\"string\">'...'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Attach wrapper straight inside the document root.</span></span><br><span class=\"line\"><span class=\"built_in\">document</span>.documentElement.appendChild(wrapper);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// Reparent the body.</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> body = <span class=\"built_in\">document</span>.body;</span><br><span class=\"line\">wrapper.appendChild(body);</span><br><span class=\"line\"><span class=\"built_in\">Object</span>.defineProperty(<span class=\"built_in\">document</span>, <span class=\"string\">'body'</span>, &#123;</span><br><span class=\"line\">  get: <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> body,</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>这段代码很简单，不过有一个细节——将 body 移到 wrapper 里面会将 document.body 重置为 null，因此我们需要将 document.body 重写回初始的 <code>&lt;body&gt;</code> 元素，可以通过 Object.defineProperty 来实现</p>\n<h4 id=\"position-fixed问题\"><a href=\"#position-fixed问题\" class=\"headerlink\" title=\"position: fixed问题\"></a>position: fixed问题</h4><p>尽管 wrapper 方案能够解决大部分问题，但是 position: fixed 的问题仍然存在 这个问题在上面那篇文章已经详细介绍过了，有关 ios 的 safari 浏览器 bug 可以<a href=\"https://bugs.webkit.org/show_bug.cgi?id=154399\" target=\"_blank\" rel=\"noopener\">点击这里</a>查看 简而言之，一个 position: fixed 元素在一个 -webkit-overflow-scrolling: touch 容器中滚动时会出现跳跃和闪现的问题。它看起来像是稍微滚动一点然而又跳回到正确的位置。可以通过这个<a href=\"https://drive.google.com/file/d/0B_v8thsbiGyDMXZMZkRFZGFRbjA/view?usp=sharing\" target=\"_blank\" rel=\"noopener\">视频演示</a>看到这个 bug。 在我们之前的解决方案中，我们将有 position: fixed 属性的元素放到了 <code>&lt;body&gt;</code> 外面，同时放到了一个虚拟“固定层”元素内部，这个“固定层”元素放在了 -webkit-overflow-scrolling: touch 容器外面 最终的 dom 结构：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">AMP</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">style</span>=<span class=\"string\">\"overflow-y: auto; -webkit-overflow-scrolling: touch;\"</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">id</span>=<span class=\"string\">\"i-amp-html-wrapper\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        display: block;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        overflow-y: auto;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        -webkit-overflow-scrolling: touch;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">style</span>=<span class=\"string\">\"position: relative;\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">!\\-\\-</span> <span class=\"attr\">document</span> <span class=\"attr\">content</span> <span class=\"attr\">--</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">id</span>=<span class=\"string\">\"i-amp-fixed-layer\"</span></span></span><br><span class=\"line\"><span class=\"tag\">      <span class=\"attr\">style</span>=<span class=\"string\">\"</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        position: absolute;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        top: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        left: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        right: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        bottom: 0;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">        pointer-events: none;</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">      \"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">!\\-\\-</span> <span class=\"attr\">fixed</span> <span class=\"attr\">elements</span> <span class=\"attr\">reparented</span> <span class=\"attr\">here</span> <span class=\"attr\">--</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>于是，<strong>我们最终获得了两个<code>&lt;html&gt;</code>元素和两个<code>&lt;body&gt;</code>元素</strong>。看起来很疯狂，但是它确实解决了两个问题： iframe 不滚动和 position:fixed 元素闪现问题 很明显，我们将取得更好的效果如果存在已久的 ios safari 问题被修复。。</p>\n","raw":null,"categories":[{"name":"mobile","path":"api/categories/mobile.json"}],"tags":[{"name":"前端","path":"api/tags/前端.json"},{"name":"AMP","path":"api/tags/AMP.json"},{"name":"fixed","path":"api/tags/fixed.json"},{"name":"ios","path":"api/tags/ios.json"}]}]}