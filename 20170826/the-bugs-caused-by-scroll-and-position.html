<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="Merrier说">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://merrier.wang">
    <!--SEO-->

<meta name="description" content="Merrier的个人博客">



<meta name="keywords" content="merrier 博客 前端 北邮人">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
<meta name="google-site-verification" content="UkMBUrF2qTuMWfmPXWFFmc_pnqCRAxHQY1ndE0Zu1p0">
    <!--Title-->


<title>iOS中采用AMP规范时的scroll和position:fixed带来的bug | Merrier说</title>


    <link rel="alternate" href="/atom.xml" title="Merrier说" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
		<script type="text/javascript">
			var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan class='cnzz_stat_icon_1264342320 hide' %3E%3Cscript%20src%3D%22https%3A%2F%2Fs95.cnzz.com%2Fz_stat.php%3Fweb_id%3D1272564536%22%3E%3C%2Fscript%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s19.cnzz.com/z_stat.php%3Fid%3D1264342320%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
		</script>
	</div>






    

    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header" style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)">
    <div class="main-header-box">
        <a class="header-avatar" href="/" title="Merrier">
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> 叩首问路，码梦为生 </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://merrier.wang">Merrier说</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/frontend/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/algorithm/"><i class="fa "></i>算法</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/series/"><i class="fa "></i>系列专栏</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>文章归档</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="iOS中采用AMP规范时的scroll和position:fixed带来的bug">
            
	            iOS中采用AMP规范时的scroll和position:fixed带来的bug
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/移动端">
            移动端
        </a>
    </span>
    

    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/前端" title="前端">
                        前端
                    </a>
                
                    <a href="/tags/AMP" title="AMP">
                        AMP
                    </a>
                
                    <a href="/tags/fixed" title="fixed">
                        fixed
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2017/08/26</span>
        </span>
        
            <span class="fa-wrap">
                <i class="fa fa-eye"></i>
                <span id="busuanzi_value_page_pv"></span>
            </span>
        
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <p>本文翻译自一位前辈的两篇文章，原文链接：</p>
<ul>
<li><a href="https://medium.com/@dvoytenko/amp-ios-scrolling-and-position-fixed-b854a5a0d451" target="_blank" rel="noopener">AMP, iOS, Scrolling and Position Fixed</a></li>
<li><a href="https://hackernoon.com/amp-ios-scrolling-and-position-fixed-redo-the-wrapper-approach-8874f0ee7876" target="_blank" rel="noopener">AMP, iOS, Scrolling and Position Fixed Redo — the wrapper approach</a></li>
</ul>
<p>首先，你需要先了解一下AMP，<a href="https://imququ.com/post/amp-project.html" target="_blank" rel="noopener">点击这里</a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们对于AMP的目标是确保document文档在不同环境中都是可嵌入的，无论是单独查看还是在webview中或者在iframe中——总体而言，它在不同环境中的功能和行为表现都应该尽可能相同。我们将从一个简单的栗子开始，在这个栗子中，一个AMP文档通过iframe被嵌入了一个web app。这听起来很正常，但是很实在的说，iframes在最近已经很少有人用了。闲话少说，html结构是这样的：</p>
<html><br><head><meta name="generator" content="Hexo 3.8.0"><br>  <title>I’m a Web App and I show AMP documents</title><br>  <style><br>    iframe {<br>      position: absolute;<br>      top: 0;<br>      left: 0;<br>      right: 0;<br>      bottom: 0;<br>    }<br>  </style><br></head><br><body><br> <iframe …="" width="100%" height="100%" scrolling="yes" src="https://cdn.ampproject.org/c/pub1.com/doc1"></iframe><br></body><br></html>

<p>上面这段代码通常来说在移动设备上表现良好。然后我们有了一个新的想法，我们尝试将iframe调整到整个document的高度，同时使用static定位，从而将滚动委托给上一层的window。然而，出于一些原因，我们放弃了这种方法：</p>
<ul>
<li>当视口高度等于文档高度时，在嵌入的AMP文档中设置“position: fixed”是不会起作用的</li>
<li>计算文档高度容易出错，而且有延迟</li>
</ul>
<p>当然，我们最终没有很好的解决方案。主要是，设置了“scrolling=yes”的iframe会丢失一些移动设备的特性，比如滚动时隐藏地址栏。然而，我们仍然觉得这已经是一个很好的折衷方案了。除此之外，一些浏览器已经开始尝试将这些特性扩展到非body滚动的情况中。我们就这样美滋滋，直到我们遇到了iOS。。</p>
<h2 id="问题1：iOS不支持iframe的“scrollable-yes”"><a href="#问题1：iOS不支持iframe的“scrollable-yes”" class="headerlink" title="问题1：iOS不支持iframe的“scrollable=yes”"></a>问题1：iOS不支持iframe的“scrollable=yes”</h2><p>Bug：<a href="https://bugs.webkit.org/show_bug.cgi?id=149264" target="_blank" rel="noopener">https://bugs.webkit.org/show_bug.cgi?id=149264</a> 简单的说：<strong>ios中不能有可以滚动的iframe</strong>。然而，我们找到了解决这个bug的方法。参考这里<a href="https://github.com/ampproject/amphtml/blob/de7a14d/src/service/viewport-impl.js#L754" target="_blank" rel="noopener">ViewportBindingNaturalIosEmbed_</a>。简短而言，我们让document中真正的<body>元素滚动。这样的话，即使iframe自身不滚动，它里面的内容也会滚动。 我们按照上面方案修改后的AMP文档如下：</body></p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br><head><meta name="generator" content="Hexo 3.8.0"></head><br><body style="
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    "><br></body><br></html>

<p>我们以为自己很牛逼，然而。。</p>
<h2 id="问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了"><a href="#问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了" class="headerlink" title="问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了"></a>问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了</h2><p>Bug：<a href="https://bugs.webkit.org/show_bug.cgi?id=106133" target="_blank" rel="noopener">https://bugs.webkit.org/show_bug.cgi?id=106133</a> 这是webkit中长期存在的一个bug。scrollTop和其他类似属性被分配给了“document.body”，但是却委托给了“document.documentElement”。最终，当“scrollingElement”是文档里的大部分元素的时候，这个问题会被解决。同时，令人惊喜的是，这个bug不会对我们在问题1中提出的解决方案造成冲突。然而，“scrollTop”将会一直是0，从而导致其他连带属性也会受到影响，比如“window.pageYOffset” 解决方案是添加一个滚动的元素到文档顶部。它的“getBoundingClientRect().top”就可以用来重新计算文档的滚动位置。 具体如下所示：</p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br><head><meta name="generator" content="Hexo 3.8.0"></head><br><body style="
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    "><br>  <div id="scroll-pos" style="
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 0;
        visibility: hidden;
      "></div><br></body><br></html>

<p>我们的JS代码：</p>
<p>function getScrollTop() {<br>  // 要对scrollPos.top取负值的原因是滚动位置在计算时，<br>  // 我们的scrollPos元素会向上滚动，在视口范围外,<br>  // 此时它的top值是负的<br>  return -scrollPos.getBoundingClientRect().top;<br>}</p>
<p>从上面的代码可以看出，这个解决方案显得很蠢，但是它确实奏效了。类似的方法可用于“scrollLeft”，“scrollHeight”以及剩余属性。 然而，我们又有了新的发现。。</p>
<h2 id="问题3：“postion-fixed”的元素在“overflow-auto”容器中会有很多bug"><a href="#问题3：“postion-fixed”的元素在“overflow-auto”容器中会有很多bug" class="headerlink" title="问题3：“postion: fixed”的元素在“overflow: auto”容器中会有很多bug"></a>问题3：“postion: fixed”的元素在“overflow: auto”容器中会有很多bug</h2><p>Bug：<a href="https://bugs.webkit.org/show_bug.cgi?id=154399" target="_blank" rel="noopener">https://bugs.webkit.org/show_bug.cgi?id=154399</a> 如果一个“position: fixed”元素在一个“overflow: auto”的容器中，它的表现会让你很失望：滚动的时候，“position: fixed”元素会跳远和闪现。它看起来像是稍微滚动一点然而又跳回到正确的位置。这个效果很差，可以通过这个<a href="https://drive.google.com/file/d/0B_v8thsbiGyDMXZMZkRFZGFRbjA/view?usp=sharing" target="_blank" rel="noopener">视频演示</a>看到这个bug。 要哭了。我们通过各种hack解决了各种bug，最后还是有一个bug，我们如何解决这个？这里有一个很疯狂的idea貌似好使。我们可以添加一个虚拟元素到“document.documentElement”（不是“body”，所以它其实是“body”的兄弟元素）。我们把它叫做“<strong>固定层</strong>”。他将占据整个视口。我们将使用CSS来找到所有的可能是“fixed”的元素（希望不会有太多。。），如果在某些时候它们是确定“fixed”的，我们就通过正确的“z-index”属性将它们移动到“固定层” 你可能看晕了，直接上代码：</p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br><head><meta name="generator" content="Hexo 3.8.0"><br>  <style><br>    #fixed-element {<br>      position: fixed;<br>      right: 20px;<br>      top: 20px;<br>    }<br>  </style><br></head><br><body style="
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    "><br>  <div id="fixed-element"><br>  </div><br></body><br><div id="fixed-layer" style="
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 0;
      pointer-events: none;
    "><br></div><br></html>

<p>当我们找到一个确实“fixed”的元素的时候，我们将它移动到“固定层”，像这样：</p>
<div id="fixed-layer" style="
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
    "><br>  <div id="fixed-element" style="pointer-events: initial; z-index: 11;"><br>  </div><br></div>

<p>因此，我们可以根据某元素是否“fixed”来将它在“body”中的原始位置和“固定层”之间移动。 这个方法就无懈可击了吗？很明显没有：</p>
<ul>
<li>这代码看都看不懂！</li>
<li>计算“z-index”会相当痛苦</li>
<li>我们将失去一些CSS祖先选择器</li>
</ul>
<p>但是它确实是有效的，可以看一下<a href="http://github.com/ampproject/amphtml/pull/2128" target="_blank" rel="noopener">这条PR</a>。还有别的idea吗？ 准确来说是有的，下面是作者第二篇文章的译文：</p>
<h1 id="回顾一下"><a href="#回顾一下" class="headerlink" title="回顾一下"></a>回顾一下</h1><p>简单回顾一下，AMP文档经常在一个滚动的iframe中进行展示。它的html结构看起来像这样：</p>
<html><br>  <head><meta name="generator" content="Hexo 3.8.0"><br>    <title>I’m a Web App and I show AMP documents</title><br>    <style><br>      iframe {<br>        position: absolute;<br>        top: 0;<br>        left: 0;<br>        right: 0;<br>        bottom: 0;<br>      }<br>    </style><br>  </head><br>  <body><br>    <iframe …="" width="100%" height="100%" scrolling="yes" src="https://cdn.ampproject.org/c/pub1.com/doc1"></iframe><br>  </body><br></html>

<p>在大部分浏览器中，上面这段代码表现很正常。但是在ios中会有很多异常表现，我们尝试了很多方法，包括通过内容调整iframe大小和滚动主文档。但是他们都有一些性能问题，具体可以参见上面的问题描述。 根本而言，ios的safari浏览器不支持滚动的iframe。换句话说，“scrolling=yes”这个属性被直接忽略了。<a href="http://jsbin.com/gugika/edit?html,css,output" target="_blank" rel="noopener">看这个例子</a>。这个bug由来已久，可以<a href="https://bugs.webkit.org/show_bug.cgi?id=149264" target="_blank" rel="noopener">在这里</a>发现。 我们在<a href="https://github.com/ampproject/amphtml/blob/de7a14d/src/service/viewport-impl.js#L754" target="_blank" rel="noopener">之前提到的一篇文章</a>中发现了一个很原始的方案。简而言之，我们让真正的“body”元素滚动。于是，即使iframe它自身不滚动，iframe中的内容也会滚动，AMP文档如下：</p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br>  <head><meta name="generator" content="Hexo 3.8.0"></head><br>  <body style="
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      "><br>    &lt;!-- document content –&gt;<br>  </body><br></html>

<p>现在我们iframe可以滚动了！这个AMP中的解决方案我们用了一年。然而，随着时间的流逝，我们发现了一系列的问题，这些问题在上一篇文章中已经详细介绍过了，这里再简单罗列一下： 给“body”添加“position: absolute”属性是作者不想看到的，会影响原始布局。另外一个副作用是我们不没办法在“body”元素上设置margin body的scrollTop，scrollLeft，scrollHeight和scrollWidth将不起作用。这个bug通过上面介绍的注入虚拟dom元素可以解决。 “position: fixed”在“-webkit-overflow-scrolling: touch”容器中会有各种bug 抵消header和footer需要给body设置边框，这个代价很昂贵，因为它缩小了滚动区域，同时可能会打破现有布局。而隐藏头部又会造成UI视觉的隔断和滚动的间断 那我们如何解决这个问题呢，我们的主角就要登场了。。</p>
<h2 id="新的解决方案——wrapper元素"><a href="#新的解决方案——wrapper元素" class="headerlink" title="新的解决方案——wrapper元素"></a>新的解决方案——wrapper元素</h2><p>这个方案已开源，可以<a href="https://github.com/ampproject/amphtml/blob/2d73ac0d9c451dee4c89ac1fa73329b69edca5a4/src/service/viewport-impl.js#L1404" target="_blank" rel="noopener">点击这里</a>查看源代码</p>
<h3 id="DOM结构"><a href="#DOM结构" class="headerlink" title="DOM结构"></a>DOM结构</h3><p>通俗来讲，wrapper元素和滚动的“body”元素是类似的。iframe在ios的safari浏览器中依然无法滚动，所以我们需要让iframe中的内容滚动。因为让<body>滚动会有一系列问题，所以我们可以创建一个滚动的wrapper，然后将它放在<html>和<body>中间。换句话说，我们将<body>元素包装在一个可滚动的容器中。 现在的dom结构类似这样：</body></body></html></body></p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br>  <head><meta name="generator" content="Hexo 3.8.0"></head><br>  <i-amp-html-wrapper style="
        display: block;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      "><br>    <body style="position: relative;"><br>      &lt;!-- document content –&gt;<br>    </body><br>  </i-amp-html-wrapper><br></html>

<p>毫无疑问，这看起来很怪，但是它确实解决了原来的问题——它让iframe在ios的safari浏览器中可以滚动。此外，它也解决了上面描述的许多问题：</p>
<ul>
<li>对于<body>元素没有任何强制要求：它仍然拥有原来的“position”属性，同时也可以拥有默认的“overflow: visible”属性。AMP允许dom中的大多数css样式，这样可以减少对代码原作者样式的干扰</body></li>
<li>可滚动的wrapper元素可以用来获取scrollTop，scrollLeft，scrollHeight和scrollWidth属性，于是之前介绍过的虚拟元素将不再需要</li>
<li>不再需要给<body>设置边界来抵消header和footer了——只需要给wrapper元素添加padding就足够了</body></li>
</ul>
<p>然而，“position: fixed”的问题仍然存在，我们稍后再谈。</p>
<h3 id="两个元素"><a href="#两个元素" class="headerlink" title="两个元素"></a>两个<html>元素</html></h3><p>我们采用了wrapper方案，然后很快就碰到了一个小问题。很多人喜欢html&gt;body选择器，而我们在<html>和<body>中间插入了i-amp-html-wrapper元素。为了解决这个问题，我们将i-amp-html-wrapper作为另外一个<html>元素 最终的dom结构长这样：</html></body></html></p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br>  <head><meta name="generator" content="Hexo 3.8.0"></head><br>  <html id="i-amp-html-wrapper" style="
        display: block;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      "><br>    <body style="position: relative;"><br>      &lt;!-- document content –&gt;<br>    </body><br>  </html><br></html>

<p>加倍奇怪，加倍好玩。总而言之现在html&gt;body选择器将正常起作用</p>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><p>AMP runtime会在启动时尽可能早的创建wrapper元素。而现有的<body>元素会作为子元素放到新建wrapper里面</body></p>
<p>// Create wrapper.<br>const wrapper = document.createElement(‘html’);<br>wrapper.id = ‘i-amp-html-wrapper’;</p>
<p>// Setup classes and styles.<br>wrapper.className = document.documentElement.className;<br>document.documentElement.className = ‘’;<br>document.documentElement.style = ‘…’;<br>wrapper.style = ‘…’;</p>
<p>// Attach wrapper straight inside the document root.<br>document.documentElement.appendChild(wrapper);</p>
<p>// Reparent the body.<br>const body = document.body;<br>wrapper.appendChild(body);<br>Object.defineProperty(document, ‘body’, {<br>  get: () =&gt; body,<br>});</p>
<p>这段代码很简单，不过有一个细节——将body移到wrapper里面会将document.body重置为null，因此我们需要将document.body重写回初始的<body>元素，可以通过Object.defineProperty来实现</body></p>
<h3 id="position-fixed问题"><a href="#position-fixed问题" class="headerlink" title="position: fixed问题"></a>position: fixed问题</h3><p>尽管wrapper方案能够解决大部分问题，但是position: fixed的问题仍然存在 这个问题在上面那篇文章已经详细介绍过了，有关ios的safari浏览器bug可以<a href="https://bugs.webkit.org/show_bug.cgi?id=154399" target="_blank" rel="noopener">点击这里</a>查看 简而言之，一个position: fixed元素在一个-webkit-overflow-scrolling: touch容器中滚动时会出现跳跃和闪现的问题。它看起来像是稍微滚动一点然而又跳回到正确的位置。可以通过这个<a href="https://drive.google.com/file/d/0B_v8thsbiGyDMXZMZkRFZGFRbjA/view?usp=sharing" target="_blank" rel="noopener">视频演示</a>看到这个bug。 在我们之前的解决方案中，我们将有position: fixed属性的元素放到了<body>外面，同时放到了一个虚拟“固定层”元素内部，这个“固定层”元素放在了-webkit-overflow-scrolling: touch容器外面 最终的dom结构：</body></p>
<html amp="" style="overflow-y: auto; -webkit-overflow-scrolling: touch;"><br>  <head><meta name="generator" content="Hexo 3.8.0"></head><br>  <html id="i-amp-html-wrapper" style="
        display: block;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      "><br>    <body style="position: relative;"><br>      &lt;!-- document content –&gt;<br>    </body><br>  </html><br>  <body id="i-amp-fixed-layer" style="
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        pointer-events: none;
      "><br>    &lt;!-- fixed elements reparented here –&gt;<br>  </body><br></html>

<p>于是，<strong>我们最终获得了两个<html>元素和两个<body>元素</body></html></strong>。看起来很疯狂，但是它确实解决了两个问题：iframe不滚动和position:fixed元素闪现问题 很明显，我们将取得更好的效果如果存在已久的ios safari问题被修复。。</p>

    </div>
    
        <div class="reward">
    <div class="reward-wrap">赏
        <div class="reward-box">
            
                <span class="reward-type">
                    <img class="alipay" src="/images/hexo_others_5.png"><b>支付宝打赏</b>
                </span>
            
            
                <span class="reward-type">
                    <img class="wechat" src="/images/hexo_others_6.png"><b>微信打赏</b>
                </span>
            
        </div>
    </div>
    <p class="reward-tip">赞赏是不耍流氓的鼓励</p>
</div>


    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="//merrier.wang" target="_blank">Merrier说</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/20170827/good-courses.html" class="pre-post btn btn-default" title='网罗天下好教程'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">网罗天下好教程</span>
        </a>
    
    
        <a href="/20170820/mobile-scroll-event.html" class="next-post btn btn-default" title='移动端滚动事件大起底'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">移动端滚动事件大起底</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
  <script id="dsq-count-scr" src="https://merrier.disqus.com/count.js" async></script>


<div id="disqus_thread">
  <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

<script type="text/javascript">
  if (document.getElementById('disqus_thread')) {
    var disqus_config = function () {
      this.page.url = 'http://merrier.wang/20170826/the-bugs-caused-by-scroll-and-position.html';
      this.page.identifier = '20170826/the-bugs-caused-by-scroll-and-position.html';
      this.page.title = 'iOS中采用AMP规范时的scroll和position:fixed带来的bug';
    };
    (function(){
      var d = document,
          s = d.createElement('script');
      s.async = true;
      s.src = 'https://merrier.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
</script>




    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-text">前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#问题1：iOS不支持iframe的“scrollable-yes”"><span class="toc-text">问题1：iOS不支持iframe的“scrollable=yes”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了"><span class="toc-text">问题2：现在scrollTop，scrollLeft，scrollHeight，scrollWidth不管用了</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题3：“postion-fixed”的元素在“overflow-auto”容器中会有很多bug"><span class="toc-text">问题3：“postion: fixed”的元素在“overflow: auto”容器中会有很多bug</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#回顾一下"><span class="toc-text">回顾一下</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#新的解决方案——wrapper元素"><span class="toc-text">新的解决方案——wrapper元素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#DOM结构"><span class="toc-text">DOM结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#两个元素"><span class="toc-text">两个元素</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实践"><span class="toc-text">实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#position-fixed问题"><span class="toc-text">position: fixed问题</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
        访问量:
        <strong id="busuanzi_value_site_pv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
        &nbsp; | &nbsp;
        访客数:
        <strong id="busuanzi_value_site_uv">
            <i class="fa fa-spinner fa-spin"></i>
        </strong>
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2018
                </span> |
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Hexo</a>
                </span> |
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>




    <script src="/assets/tagcanvas.min.js?rev=2.9"></script>
    <script>
        var tagOption = {
            textColour: '#444', // 字体颜色
            outlineMethod: 'block', // 选中模式
            outlineColour: '#FFDAB9', // 选中模式的颜色
            interval: 30 || 30, // 动画帧之间的时间间隔，值越大，转动幅度越大
            textHeight: 13,
            outlineRadius: 3,
            freezeActive: true || '', // 选中的标签是否继续滚动
            frontSelect: true || '', // 不选标签云后部的标签
            initial: [0.1, -0.1],
            depth: 0.5,
            decel: 0.95,
            maxSpeed: 0.03,
            reverse: true || '', // 是否反向触发
            fadeIn: 500, // 进入动画时间
            wheelZoom: true || '' // 是否启用鼠标滚轮
        }
        TagCanvas.Start('tag-cloud-3d','',tagOption);
    </script>



    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>